---
title: Old version usage documentation
description: Old version usage documentation of the py-xiaozhi project, providing usage guides for earlier versions
outline: deep
---

#py-xiaozhi usage documentation (please read the usage documentation carefully)

![Image](https://github.com/user-attachments/assets/df8bd5d2-a8e6-4203-8084-46789fc8e9ad)

## Introduction to use

- Voice mode is divided into two types: long press dialogue and automatic dialogue. The button in the lower right corner displays the current mode.
- Long press to talk: press and hold to speak and release to send
- Automatic conversation: Just click to start the conversation. When the interface displays Listening, it means you are speaking. After speaking, it will be sent automatically.
- gui mode:
- F2 key: long press to speak
- F3 key: interrupt conversation
- cli mode
- F2 key: Press once to start an automatic conversation
- F3 key: interrupt conversation
  
## Configuration instructions

### Basic project configuration

#### Configuration file description

The project uses two configuration methods: initial configuration template and runtime configuration file.

1. **Initial Configuration Template**
- Location: `/src/utils/config_manager.py`
- Function: Provide a default configuration template, and the configuration file will be automatically generated when running for the first time.
- Usage scenario: Modify this file when running for the first time or when you need to reset the configuration.

2. **Runtime configuration file**
- Location: `/config/config.json`
- Function: Store actual runtime configuration information
- Usage scenario: Modify this file for daily use

#### Configuration item description

- Just get what configuration you need through config_manager, refer to websocket or iot\things\temperature_sensor.py
- For example, to get the "endpoint" of "MQTT_INFO", you can get the **endpoint** by `config.get_config("MQTT_INFO.endpoint")`

```json
{
"CLIENT_ID": "Automatically generated client ID",
"DEVICE_ID": "Device MAC address",
  "NETWORK": {
"OTA_VERSION_URL": "OTA update address",
"WEBSOCKET_URL": "WebSocket server address",
"WEBSOCKET_ACCESS_TOKEN": "Access Token"
  },
  "MQTT_INFO": {
"endpoint": "MQTT server address",
"client_id": "MQTT client ID",
"username": "MQTT username",
"password": "MQTT password",
"publish_topic": "Publish topic",
"subscribe_topic": "Subscribe topic"
  },
"USE_WAKE_WORD": false, // Whether to enable voice wake-up
"WAKE_WORDS": [ // Wake word list
"Xiao Zhi",
"Hello Xiao Ming"
  ],
"WAKE_WORD_MODEL_PATH": "./models/vosk-model-small-cn-0.22", // Wake up model path
  "TEMPERATURE_SENSOR_MQTT_INFO": {
"endpoint": "Your Mqtt address",
    "port": 1883,
    "username": "admin",
    "password": "dtwin@123",
    "publish_topic": "sensors/temperature/command",
    "subscribe_topic": "sensors/temperature/device_001/state"
  },
"CAMERA": { //Visual configuration
    "camera_index": 0,
    "frame_width": 640,
    "frame_height": 480,
    "fps": 30,
"Local_VL_url": "https://open.bigmodel.cn/api/paas/v4/", // Zhipu's application address https://open.bigmodel.cn/
"VLapi_key": "your key"
  }
// ...you can add any configuration
}
```

#### Configuration Modification Guide

1. **First time configuration**
- Run the program directly and the system will automatically generate a default configuration file
- If you need to modify the default value, you can edit `DEFAULT_CONFIG` in `config_manager.py`

2. **Change server configuration**
- Open `/config/config.json`
- Modify `NETWORK.WEBSOCKET_URL` to the new server address
- Example:

     ```json
     "NETWORK": {
"WEBSOCKET_URL": "ws://your server address:port number/"
     }
     ```

3. **Enable voice wake-up**
- Modify `USE_WAKE_WORD` to `true`
- Wake words can be added or modified in the `WAKE_WORDS` array

#### Notes

- After modifying the configuration file, you need to restart the program to take effect.
- WebSocket URL must start with `ws://` or `wss://`
- CLIENT_ID will be automatically generated when running for the first time. It is recommended not to modify it manually.
- DEVICE_ID uses the device MAC address by default and can be modified as needed
- The configuration file uses UTF-8 encoding, please use an editor that supports UTF-8 to modify it.

## Startup instructions

### System dependency installation

#### Windows

1. **Install FFmpeg**

   ```bash
# Method 1: Use Scoop to install (recommended)
   scoop install ffmpeg
   
#Method 2: Manual installation
# 1. Visit https://github.com/BtbN/FFmpeg-Builds/releases to download
# 2. Unzip and add the bin directory to the system PATH
   ```

2. **Opus audio codec library**
- The project will automatically introduce opus.dll by default, no need to install it manually
- If you encounter problems, copy `/libs/windows/opus.dll` to one of the following locations:
- Application directory
     - `C:\Windows\System32`

#### Linux (Debian/Ubuntu)

```bash
#Install system dependencies
sudo apt-get update
sudo apt-get install python3-pyaudio portaudio19-dev ffmpeg libopus0 libopus-dev

# Install volume control dependencies (choose one of the following three)
# 1. PulseAudio tool (recommended)
sudo apt-get install pulseaudio-utils

# 2. Or ALSA tool
sudo apt-get install alsa-utils

# 3. If you need to use alsamixer, you also need to install expect.
sudo apt-get install alsa-utils expect


sudo apt install build-essential python3-dev
```

#### macOS

```bash
# Use Homebrew to install system dependencies
brew install portaudio opus python-tk ffmpeg gfortran
brew upgrade tcl-tk
```

### Python dependency installation

#### Method 1: Use venv (recommended)

```bash
# 1. Create a virtual environment
python -m venv .venv

# 2. Activate virtual environment
# Windows
.venv\Scripts\activate
# Linux/macOS
source .venv/bin/activate

# 3. Install dependencies
# Windows/Linux
pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple
# macOS
pip install -r requirements_mac.txt -i https://mirrors.aliyun.com/pypi/simple
```

#### Method 2: Use Conda

```bash
# 1. Create Conda environment
conda create -n py-xiaozhi python=3.12

# 2. Activate the environment
conda activate py-xiaozhi

# 3. Install Conda specific dependencies
conda install conda-forge::libopus
conda install conda-forge::ffmpeg

# 4. Install Python dependencies
# Windows/Linux
pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple
# macOS
pip install -r requirements_mac.txt -i https://mirrors.aliyun.com/pypi/simple
```

### Wake word model

- [Wake word model download](https://alphacephei.com/vosk/models)
- After downloading, unzip it and put it in the root directory/models
- Read vosk-model-small-cn-0.22 small model by default
- ![Image](../images/wake word.png)

### IoT function description

#### IoT module structure

```
├── iot # IoT device related modules
│ ├── things # Specific device implementation directory
│ │ ├── lamp.py # Intelligent lamp control implementation
│ │ │ └── Lamp # Lamp device category, providing functions such as switching, adjusting brightness, changing color, etc.
│ │ ├── music_player.py # Music player implementation
│ │ │ └── MusicPlayer # Music player class, providing functions such as playing, pausing, switching songs, etc.
│ │ └── speaker.py # Volume control implementation
│ │ └── Speaker # Speaker type, providing volume adjustment, muting and other functions
│ ├── thing.py # IoT device base class definition
│ │ ├── Thing # Abstract base class for all IoT devices
│ │ ├── Property # Device property class, defining the variable state of the device
│ │ ├── Action # Device action class, defining the operations that the device can perform
│ │ └── Event # Device event class, defining events that can be triggered by the device
│ └── thing_manager.py # IoT device manager (unified management of various devices)
│ └── ThingManager # Device manager implemented in singleton mode, responsible for device registration, search and command distribution
```

#### Iot status flow

```text
                                  +----------------+
| User Voice |
| Command |
                                  +-------+-------+
                                          |
                                          v
                                  +-------+-------+
| Voice recognition |
                                  |   (STT)      |
                                  +-------+-------+
                                          |
                                          v
                                  +-------+-------+
| LLM processing instructions |
                                  |               |
                                  +-------+-------+
                                          |
                                          v
                                  +-------+-------+
| Generate IoT commands |
                                  |               |
                                  +-------+-------+
                                          |
                                          v
                          +---------------+---------------+
| Application receives IoT messages |
                          |    _handle_iot_message()     |
                          +---------------+---------------+
                                          |
                                          v
                          +---------------+---------------+
                          |    ThingManager.invoke()     |
                          +---------------+---------------+
                                          |
           +------------------+------------------+------------------+
           |                  |                  |                  |
           v                  v                  v                  v
+----------+-------+  +-------+--------+  +------+---------+  +----+-----------+
|     Lamp         |  |    Speaker     |  |   MusicPlayer  |  |    CameraVL    |
| (Lamp control device) | | (Volume control device) | | (Music playing device) | | (Camera and vision) |
+----------+-------+  +-------+--------+  +------+---------+  +----+-----------+
           |                  |                  |                  |
           |                  |                  |                  |
           |                  |                  |                  |
           |                  |                  |                  v
           |                  |                  |           +------+---------+
           |                  |                  |           |   Camera.py    |
| | | | (Camera Control) |
           |                  |                  |           +------+---------+
           |                  |                  |                  |
           |                  |                  |                  v
           |                  |                  |           +------+---------+
           |                  |                  |           |     VL.py      |
| | | | (visual recognition processing) |
           |                  |                  |           +------+---------+
           |                  |                  |                  |
           +------------------+------------------+------------------+
                                          |
                                          v
                          +---------------+---------------+
| Perform device operations |
                          +---------------+---------------+
                                          |
                                          v
                          +---------------+---------------+
| Update device status |
                          |    _update_iot_states()      |
                          +---------------+---------------+
                                          |
                                          v
                          +---------------+---------------+
| Send status updates to the server |
                          |   send_iot_states(states)    |
                          +---------------+---------------+
                                          |
                                          v
                          +---------------+---------------+
| Server updates device status |
                          +---------------+---------------+
                                          |
                                          v
                          +---------------+---------------+
| Return execution results to the user |
| (voice or interface feedback) |
                          +-------------------------------+
```

#### IoT device management

- The IoT module adopts a flexible multi-protocol communication architecture:
- MQTT protocol: used to communicate with standard IoT devices, such as smart lights, air conditioners, etc.
- HTTP protocol: used to interact with web services, such as obtaining online music, calling multi-modal AI models, etc.
- Extensible to support other protocols: such as WebSocket, TCP, etc.
-Supports automatic discovery and management of IoT devices
- IoT devices can be controlled through voice commands, such as:
- "View current IoT devices"
- "Turn on the lights in the living room"
- "Turn off air conditioning"
- "Set temperature to 26 degrees"
- "Open camera"
- "Turn off camera"
- "Identification screen"

#### Add new IoT device

1. Create a new device class in the `src/iot/things` directory
2. Inherit the `Thing` base class and implement the necessary methods
3. Register new devices in `thing_manager.py`

### Notes

1. Ensure that the appropriate server is configured correctly and accessible:
- MQTT server configuration (for IoT devices)
- API interface address (for HTTP service)
2. Devices/services with different protocols need to implement corresponding connection and communication logic
3. It is recommended to add basic error handling and reconnection mechanisms to each new device/service
4. New communication protocols can be supported by extending the Thing base class
5. When adding new devices, it is recommended to conduct a communication test first to ensure a stable connection.

#### Online music configuration

- Access to online audio sources, no need to configure yourself, available by default

### Operation mode description

#### Run in GUI mode (default)

```bash
python main.py
```

#### Run in CLI mode

```bash
python main.py --mode cli
```

#### Build and package

Package as executable using PyInstaller:

```bash
# Windows
python scripts/build.py

# macOS
python scripts/build.py

# Linux
python scripts/build.py
```

### Notes

1. It is recommended to use Python 3.9.13+ version, 3.12 is recommended
2. Windows users do not need to manually install opus.dll, the project will be processed automatically
3. ffmpeg and Opus must be installed when using the Conda environment
4. When using the Conda environment, please do not share the same Conda environment with esp32-server, because the server-side websocket depends on a higher version than this project.
5. It is recommended to use domestic mirror sources to install dependencies, which can improve download speed.
6. macOS users need to use special requirements_mac.txt
7. Make sure that the system dependencies are installed before installing Python dependencies.
8. If you use xiaozhi-esp32-server as the server, the project can only respond automatically through dialogue.
9. esp32-server video deployment tutorial [New version! Complete tutorial on local deployment of Xiaozhi AI server, supporting DeepSeek access](https://www.bilibili.com/video/BV1GvQWYZEd2/?share_source=copy_web&vd_source=86370b0cff2da3ab6e3d26eb1cab13d3)
10. The volume control function requires the installation of specific dependencies. The program will automatically check and prompt for missing dependencies upon startup.

### Volume control function description

This application supports adjusting the system volume and installs different dependencies according to the needs of different operating systems:

1. **Windows**: Use pycaw and comtypes to control system volume
2. **macOS**: Use applescript to control system volume
3. **Linux**: Use pactl (PulseAudio), wpctl (PipeWire), amixer (ALSA) or alsamixer to control the volume according to the system environment

The application automatically checks whether these dependencies are installed when it starts. If dependencies are missing, corresponding installation instructions will be displayed.

#### How to use volume control

- **GUI Mode**: Use the volume slider on the interface to adjust the volume
- **CLI mode**: Use the `v <volume value>` command to adjust the volume, for example `v 50` sets the volume to 50%

### State flow diagram

```
                        +----------------+
                        |                |
                        v                |
+------+ wake word/button +------------+ | +------------+
| IDLE | -----------> | CONNECTING | --+-> | LISTENING  |
+------+              +------------+       +------------+
   ^                                            |
| | Voice recognition completed
   |          +------------+                    v
   +--------- |  SPEAKING  | <-----------------+
Finish playing +----------------+
```

## Get help

If you encounter problems:

1. Check the docs/Exception Summary.md document first.
2. Submit an issue via GitHub Issues
3. Ask for help through AI assistants
4. Contact the author (WeChat on the homepage) (please bring your own Todesk link and explain your purpose, the author will handle it on weekday evenings)
