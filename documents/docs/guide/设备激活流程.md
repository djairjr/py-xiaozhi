#Device activation process

## Overview

The device activation process is responsible for verifying device identity and obtaining necessary configuration information. The system supports two activation protocols, v1 and v2. The v2 protocol uses a security verification mechanism based on HMAC-SHA256.

## System initialization phase

### Stage division

System initialization is divided into three main phases:

1. **Device Fingerprint Phase**: Prepare device identity information
2. **Configuration management phase**: Initializing the configuration manager
3. **OTA configuration phase**: Obtain server configuration information

### Phase 1: Device Fingerprinting

Collect and manage device identity information through the `DeviceFingerprint` class:

- Generate or load device serial number (Serial Number)
- Create or obtain HMAC keys
- Manage local activation status
- Get standardized MAC address

The device fingerprint file is stored in `config/efuse.json` and contains:
```json
{
  "serial_number": "SN-xxxxxxxxxxxxxxxx",
"hmac_key": "64-bit hexadecimal string",
  "mac_address": "xx:xx:xx:xx:xx:xx",
  "activated": false
}
```

### Phase 2: Configuration Management

Initialize the configuration manager and ensure key configuration items:

- Initialize CLIENT_ID (UUID format)
- Set DEVICE_ID (MAC address) from device fingerprint
- Verify configuration integrity

### The third stage: OTA configuration

Request configuration information from the OTA server:

**Request URL**: `SYSTEM_OPTIONS.NETWORK.OTA_VERSION_URL`

**Request header**:
```
Device-Id: MAC address
Client-Id: client UUID
Content-Type: application/json
User-Agent: board_type/app_name-version
Accept-Language: zh-CN
Activation-Version: version (v2 protocol only)
```

**Request body**:
```json
{
  "application": {
"version": "Application version",
"elf_sha256": "HMAC key"
  },
  "board": {
"type": "Device type",
"name": "Application name",
"ip": "local IP",
"mac": "MAC address"
  }
}
```

## Activation status analysis

The system performs status analysis based on local activation status and server response:

### Status combination processing

1. **Local not activated + server returns activation data**: activation process required
2. **Local activated + server no activation data**: The device has been activated
3. **Local not activated + server no activation data**: Automatically repair local status
4. **Local activated + server returns activation data**: status is inconsistent and may need to be reactivated

### Server response format

Response when configuration is successfully obtained:
```json
{
  "mqtt": {
"endpoint": "mqtt server address",
"client_id": "MQTT client ID",
"username": "username",
"password": "password",
"publish_topic": "Publish topic"
  },
  "websocket": {
"url": "WebSocket server URL",
"token": "Access token"
  }
}
```

Response when activation is required:
```json
{
  "activation": {
"message": "Activation prompt message",
"code": "6-digit verification code",
"challenge": "Random string used for HMAC signature",
    "timeout_ms": 30000
  }
}
```

## v2 protocol activation process

###Activate trigger conditions

When the system analysis finds that activation is required, the activation process is started:

1. Check device serial number and HMAC key
2. Display verification code to user
3. Play voice prompts
4. Perform HMAC signature verification

### HMAC signature calculation

Sign the challenge using the HMAC-SHA256 algorithm:
```python
signature = hmac.new(
    hmac_key.encode('utf-8'),
    challenge.encode('utf-8'),
    hashlib.sha256
).hexdigest()
```

### Activation request

**Request URL**: `OTA_VERSION_URL + "activate"`

**Request header**:
```
Activation-Version: 2
Device-Id: MAC address
Client-Id: client UUID
Content-Type: application/json
```

**Request body**:
```json
{
  "Payload": {
    "algorithm": "hmac-sha256",
"serial_number": "Device serial number",
"challenge": "server challenge",
"hmac": "HMAC signature"
  }
}
```

### Response processing

- **HTTP 200**: Activation successful, update local activation status
- **HTTP 202**: Wait for the user to enter the verification code and continue polling
- **HTTP 4xx**: Activation failed, error message logged

### Retry mechanism

The activation request uses a long polling mechanism:

- Maximum number of retries: 60 times
- Retry interval: 5 seconds
- Total timeout: 5 minutes
- Replay the captcha prompt every time you retry

## User interface integration

### GUI mode

Provide a graphical interface through the `ActivationWindow` class:

- Show verification code
- Provide activation status feedback
- Support deactivation operation
- Asynchronously wait for activation to complete

### CLI mode

Provides a command line interface through the `CLIActivation` class:

- Console output verification code
- Voice playback verification code
- Show activation progress

## Security mechanism

1. **Device Unique Identification**: Generate a unique serial number based on hardware information
2. **HMAC-SHA256 signature**: Prevent forged activation requests
3. **Verification code verification**: User manually enters to confirm device ownership
4. **Long polling mechanism**: adapt to the network environment and avoid frequent requests

## Configuration update

After successful activation, the system automatically updates the configuration:

- MQTT connection information
- WebSocket connection information
- Local activation status flag

After the configuration update is complete, the application continues the normal startup process.