# Project packaging tutorial

## Overview

UnifyPy 2.0 is a cross-platform Python application packaging tool that supports packaging Python projects into native installation packages for Windows (EXE), macOS (DMG), and Linux (DEB) platforms.

**Core Features**: Interactive configuration wizard, intelligent path processing, automatic permission management, parallel build, rollback system.

> ðŸ“š **Full Documentation**: [UnifyPy GitHub Repository](https://github.com/huangjunsen0406/UnifyPy)

## Environment preparation

### 1. Install project dependencies

```bash
# Enter the project directory
cd /path/to/py-xiaozhi

# Install project dependencies
pip install -r requirements.txt        # Windows/Linux
pip install -r requirements_mac.txt    # macOS
```

### 2. Install UnifyPy

```bash
pip install unifypy
```

> **Note**: UnifyPy is packaged using PyInstaller and needs to access all Python packages in the current environment. Make sure UnifyPy and project dependencies are installed in the same environment.

### 3. Platform specific tools

#### Windows platform

Install [Inno Setup](https://jrsoftware.org/isdl.php) (used to create the installer)

- After installation, configure the path in build.json, or set the environment variable `INNO_SETUP_PATH`

#### macOS platform

- No additional installation required (UnifyPy built-in create-dmg tool)

#### Linux platform

**Install packaging tools**:

```bash
# DEB format packaging tool
sudo apt-get install dpkg-dev fakeroot
```

**Install the compilation environment** (important):

```bash
# Install development tools and libraries (required for NumPy and other dependencies)
sudo apt update
sudo apt install -y build-essential python3-dev python3-pip python3-setuptools \
    libopenblas-dev liblapack-dev gfortran patchelf autoconf automake \
    libtool cmake libssl-dev libatlas-base-dev

#Install build system
pip install meson ninja
sudo apt install -y meson ninja-build
```

**NumPy compilation environment configuration**:

```bash
# Set environment variables
export BLAS=openblas
export LAPACK=openblas
export NPY_NUM_BUILD_JOBS=$(nproc)

# Verify that NumPy is available
python -c "import numpy; print('NumPy version:', numpy.__version__)"
```

> **Tip**: It is recommended to use the conda environment to avoid most compilation problems:
> ```bash
> conda create -n build_env python=3.9
> conda activate build_env
> conda install numpy scipy openblas-devel
> pip install unifypy
> ```

## Quick start

### Method 1: Interactive Wizard (recommended for first time use)

```bash
# Start the configuration wizard in the project directory
cd /path/to/py-xiaozhi
unifypy . --init
```

The wizard will guide you through:
1. Basic information configuration (name, version, entry file)
2. Target platform selection (Windows/macOS/Linux)
3. PyInstaller configuration (single file/window mode, data directory)
4. Platform-specific configuration (permissions, icons, installation options)
5. Automatically generate `build.json` and optionally build immediately

### Method 2: Use existing configuration

The project already contains a preconfigured `build.json`, which can be packaged directly:

```bash
#Basic packaging
unifypy . --config build.json

# Clean and rebuild
unifypy . --config build.json --clean

# Verbose output (recommended)
unifypy . --config build.json --verbose

# Only generate executable files
unifypy . --config build.json --skip-installer

# Build multiple formats in parallel
unifypy . --config build.json --parallel --max-workers 4
```

## Packaging commands for each platform

### Windows

```bash
unifypy . --config build.json
```

Output:
- Executable file: `dist/xiaozhi/`
- Installer: `dist/installer/xiaozhi-1.0.0-setup.exe`

### macOS

```bash
# Development mode (automatically configure permissions)
unifypy . --config build.json --development

# Production mode
unifypy . --config build.json
```

Output:
- Application package: `dist/xiaozhi/XiaoZhi.app`
- Disk image: `dist/installer/xiaozhi-1.0.0.dmg`

### Linux

```bash
unifypy . --config build.json
```

Output:
- Executable file: `dist/xiaozhi/`
- DEB installation package: `dist/installer/xiaozhi-1.0.0.deb`

## Special instructions for Linux platform

### NumPy compilation issues

**Symptoms**: Compilation errors, missing BLAS/LAPACK libraries, etc.

**Solution**:

```bash
# Option 1: Check and install missing development libraries
sudo apt install -y libopenblas-dev liblapack-dev gfortran

# Option 2: Use precompiled wheel package (recommended)
pip install numpy --force-reinstall

# Option 3: Set environment variables and then reinstall
export BLAS=openblas
export LAPACK=openblas
export NPY_NUM_BUILD_JOBS=4
pip install numpy --no-cache-dir

# Option 4: Use conda environment (the most stable)
conda install numpy scipy openblas-devel
```

### Dependency compatibility

The packaged program cannot run on other Linux systems?

**SOLUTION**: Building on older Linux distributions, it is recommended to use:
- Ubuntu 18.04 LTS or 20.04 LTS
- CentOS 7

Or use static linking:
```bash
pip install staticx
```

## FAQ

### Q1: I donâ€™t know how to configure it for the first time?

```bash
unifypy . --init # Use interactive wizard
```

### Q2: Packaging failed?

```bash
# Clean up and try again, enable verbose output
unifypy . --config build.json --clean --verbose
```

### Q3: macOS permission configuration problem?

```bash
# Use development mode to automatically generate permission files
unifypy . --config build.json --development --verbose
```

### Q4: Dependency conflict?

```bash
# Create a unified environment
conda create -n packaging python=3.9
conda activate packaging
pip install unifypy
pip install -r requirements.txt
```

### Q5: The configuration file path cannot be found?

UnifyPy 2.0 uses smart path processing, and relative paths in configuration files are automatically resolved to absolute paths relative to the **project directory**.

Example:
```json
{
"icon": "assets/icon.png" // Automatically parsed to /path/to/project/assets/icon.png
}
```

## Advanced features

### Roll back the system

```bash
# List available rollback sessions
unifypy . --list-rollback

# Roll back to the specified session
unifypy . --rollback SESSION_ID
```

### Parallel build

```bash
# Multi-format parallel construction
unifypy . --config build.json --parallel --max-workers 4
```

### macOS automatic permission management

UnifyPy automatically generates entitlements.plist and updates Info.plist:

```bash
# Development mode (including debugging permissions)
unifypy . --config build.json --development

# Production mode (only necessary permissions)
unifypy . --config build.json --production
```

## More information

- **Complete configuration document**: View [UnifyPy README](https://github.com/huangjunsen0406/UnifyPy)
- **Advanced configuration example**: refer to `build_comprehensive.json` in the repository
- **PyInstaller parameters**: refer to [PyInstaller official documentation](https://pyinstaller.org/en/stable/usage.html)

## Best Practices

1. **Environment Management**: Use conda to create a dedicated packaging environment
2. **First use**: Use the `--init` wizard to quickly generate configurations
3. **Debug Build**: Always use the `--verbose` parameter
4. **Clean build**: Use `--clean` regularly to ensure a clean build
5. **Linux Packaging**: Built on Ubuntu 18.04/20.04 to ensure compatibility
6. **macOS packaging**: use `--development` mode during development phase
