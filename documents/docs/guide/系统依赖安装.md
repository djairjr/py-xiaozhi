# System dependency installation

## Overview

This document provides a complete dependency installation guide for the py-xiaozhi project, including system-level dependencies and Python environment configuration. Please follow the documentation sequence to install.

> Compatibility range: Ubuntu **20.04/22.04/23.10/24.04/25.xx**.
> **Qt installation source is unified: only use pip or conda to install PyQt5 (do not use apt's python3-pyqt5)**. ARM Ubuntu (aarch64) strongly recommends **conda** to install PyQt.

## System dependency installation

### Windows

#### Multimedia components

```bash
# Install using Scoop (recommended)
scoop install ffmpeg

# Or use Conda
conda install -c conda-forge ffmpeg opus
```

#### Manually install FFmpeg

1. Download: [BtbN/FFmpeg-Builds](https://github.com/BtbN/FFmpeg-Builds/releases)
2. After decompression, add the `bin` directory to the system environment variable `PATH`

#### Opus audio codec

* The project already contains `opus.dll`, usually no additional installation is required
* If you encounter problems, you can copy `/libs/windows/opus.dll` to:

* Application running directory
  * `C:\Windows\System32`

### Linux (Debian/Ubuntu)

> Compatible with Ubuntu **20/22/23/24/25**. The following commands are applicable to the above versions; if individual minimalist images are missing packages, just follow the prompts to reinstall them.
> **Please do not install `python3-pyqt5*` of apt, Qt only uses pip/conda. **

#### Core dependencies

```bash
# Update package manager
sudo apt-get update

#Install core dependencies (excluding Qt)
sudo apt-get install -y portaudio19-dev libportaudio2 ffmpeg libopus0 libopus-dev \
                        build-essential python3-venv python3-pip libasound2-dev \
                        libxcb-xinerama0 libxkbcommon-x11-0
```

* `libxcb-xinerama0`, `libxkbcommon-x11-0`: Qt GUI runtime libraries that may be missing in some desktop environments; installation is more stable.
* **Audio system** (choose one of three):

* PulseAudio tool (recommended):

    ```bash
    sudo apt-get install -y pulseaudio-utils
    ```

  * ALSAï¼š

    ```bash
    sudo apt-get install -y alsa-utils
    ```

* ALSA + interactive tools:

    ```bash
    sudo apt-get install -y alsa-utils expect
    ```

* Tip: Ubuntu 24+ defaults to PipeWire, but `pulseaudio-utils` is still available through the `pipewire-pulse` compatibility layer and does not affect this project.

#### Development tools (optional)

```bash
sudo apt-get install -y gcc g++ make cmake pkg-config
```

### macOS

```bash
# Install using Homebrew
brew install portaudio opus ffmpeg gfortran
brew upgrade tcl-tk

#Install Xcode command line tools (if not installed)
xcode-select --install
```

## Python environment configuration

### Method 1: Use Miniconda (recommended)

#### 1. Download Miniconda

| Operating system | Architecture | Download command |
| ----------- | ------------- | ------------------------------------------------------------------------------------------------------------------- |
| **Linux**   | x86\_64       | `wget -O Miniconda3-latest-Linux-x86_64.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh`   |
| **Linux**   | ARM64         | `wget -O Miniconda3-latest-Linux-aarch64.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh` |
| **macOS**   | Intel         | `wget -O Miniconda3-latest-MacOSX-x86_64.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh` |
| **macOS**   | Apple Silicon | `wget -O Miniconda3-latest-MacOSX-arm64.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-arm64.sh`   |
| **Windows** | x86\_64 | [Download link](https://repo.anaconda.com/miniconda/Miniconda3-latest-Windows-x86_64.exe) |

#### 2. Install Miniconda

**Linux/macOS**

```bash
#Add execution permissions
chmod +x Miniconda3-latest-*.sh

# Run the installer
./Miniconda3-latest-*.sh
```

Choices during installation:

1. License Agreement: Press `Enter` or `q` to skip, enter `yes` to accept
2. Installation path: Use the default path (recommended)
3. Initialization: Enter `yes` (recommended)

#### 3. Configure the environment (if necessary)

```bash
# If environment variables are not automatically configured
echo 'export PATH="$HOME/miniconda3/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

#Initialize conda
conda init
```

#### 4. Verify installation

```bash
conda --version
```

#### 5. Optimize configuration

```bash
# Turn off automatic activation of base environment
conda config --set auto_activate_base false

# Add conda-forge channel
conda config --add channels conda-forge
```

### Method 2: Use system Python + venv

```bash
#Create virtual environment
python3 -m venv .venv

# Activate virtual environment
# Linux/macOS
source .venv/bin/activate
# Windows
.venv\Scripts\activate
```

## (Unified) Qt is installed with pip/conda

> Install PyQt5 using pip or conda only, not PyQt using apt.
> **ARM Ubuntu (aarch64) strongly recommends: Conda to install PyQt**; pip or conda is available for x86\_64. Don't mix the two.

### Route B1: Install PyQt with Conda (ARM Ubuntu recommended)

```bash
# Recommended minimum system dependencies (already installed in "Core Dependencies" and can be skipped)
sudo apt-get update
sudo apt-get install -y libportaudio2 portaudio19-dev ffmpeg libopus0 \
                        libasound2-dev libxcb-xinerama0 libxkbcommon-x11-0

# Create and enter the environment
conda create -n py-xiaozhi python=3.10 -y
conda activate py-xiaozhi

# Use conda to install PyQt and C++ runtime libraries (to avoid GLIBCXX problems)
conda install -c conda-forge -y pyqt=5.15 libstdcxx-ng>=13 libgcc-ng>=13

# PortAudio binding (choose 1 from 2)
# A) Use system libportaudio (already installed with apt)
pip install sounddevice
# B) Leave it all to conda (not dependent on the system)
# conda install -c conda-forge -y portaudio jack python-sounddevice

# Other dependencies
pip install -r requirements.txt # Make sure requirements.txt does not contain PyQt5
```

### Route B2: pip install PyQt (x86\_64 is more stable; ARM may not have wheels, not recommended)

```bash
#If you fallback to the dev dependencies that may be needed for source code building (only reinstall if it fails)
sudo apt-get install -y build-essential python3-dev \
                        qtbase5-dev qtchooser qt5-qmake qtmultimedia5-dev

# venv
python3 -m venv .venv
source .venv/bin/activate

# Install PyQt (ARM will try to build it locally if there is no manylinux wheel. If it fails, please use the conda solution instead)
pip install "PyQt5==5.15.*" PyQt5-Qt5 PyQt5-sip

# Other dependencies
pip install -r requirements.txt # Also do not install PyQt5
```

> **Don't mix**:
>
> * If you choose PyQt with **pip/conda**, don't **apt install python3-pyqt5*`.
> * If you choose **apt**'s PyQt (this solution has been removed from this document), you **don't** need to install PyQt through pip/conda.

## Package manager optimization

### Source replacement tool (recommended)

```bash
# Windows (PowerShell administrator privileges)
winget install RubyMetric.chsrc --source winget

# Linux/macOS
wget -O- aslant.top/chsrc.sh | sudo bash

# Configure pip source
chsrc set pip
```

### Manually configure pip source

```bash
# Use Alibaba Cloud mirror source
pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/
pip config set install.trusted-host mirrors.aliyun.com
```

## Project dependency installation

### 1. Create project environment

```bash
# Use Conda (recommended)
conda create -n py-xiaozhi python=3.10 -y
conda activate py-xiaozhi

# Or use venv
python3 -m vvenv .venv
source .venv/bin/activate  # Linux/macOS
# .venv\Scripts\activate   # Windows
```

### 2. Install Python dependencies

```bash
# Linux/Windows
pip install -r requirements.txt

# macOS
pip install -r requirements_mac.txt
```

### 3. Verify installation

```bash
# Check key dependencies (PyQt is provided by conda or pip, whichever route you choose)
python -c "import sounddevice; print('SoundDevice OK')"
python -c "import opuslib; print('Opus OK')"
python -c "import PyQt5.QtCore as q; print('PyQt5 OK, Qt', q.QT_VERSION_STR)"
```

## troubleshooting

### FAQ

#### SoundDevice installation failed

```bash
# Ubuntu/Debian
sudo apt-get install -y portaudio19-dev libasound2-dev libportaudio2

# macOS
brew install portaudio

# Windows
pip install sounddevice
```

#### PyQt5 installation failed

* **Conda route (ARM recommended)**:

```bash
conda install -c conda-forge -y pyqt=5.15 libstdcxx-ng>=13 libgcc-ng>=13
```

* **pip route (mainly x86\_64)**: Confirm whether there are manylinux wheels; if the ARM source code build fails, please use conda instead.

#### Opus library is missing

* macOS users are preferred to use conda to install (otherwise they need to handle the dynamic library path themselves):

```bash
conda install -c conda-forge opus
# If necessary:
# nano ~/.zshrc
# export DYLD_LIBRARY_PATH=/opt/homebrew/lib:$DYLD_LIBRARY_PATH
# source ~/.zshrc
```

* Linux

```bash
sudo apt-get install -y libopus0 libopus-dev
```

* macOS

```bash
brew install opus
```

#### Permission issues (Linux)

```bash
#Add user to audio group
sudo usermod -a -G audio $USER

# Valid after logging in again
```

## Version requirements

* **Python**: 3.9.13+ (3.10 is recommended, 3.11 is the highest)
* **PyQt5**: 5.15+
* **SoundDevice**: 0.4.4+
* **FFmpeg**: 4.0+
* **Opus**: 1.3+
* **PortAudio**: 19.0+

## Notes

1. It is recommended to use Conda environment to manage dependencies (** conda is highly recommended for ARM Ubuntu installation of PyQt**)
2. Do not share the Conda environment with esp32-server
3. macOS users must use `requirements_mac.txt`
4. Windows users do not need to manually install `opus.dll`
5. The project uses SoundDevice instead of PyAudio and PyQt5 as the GUI framework
6. Make sure that the system dependencies are installed before installing the Python dependencies.
7. Using domestic mirror sources can increase download speed
8. **Don't mix PyQt installation sources**: only use **pip or conda**, **don't use apt's python3-pyqt5**\*
