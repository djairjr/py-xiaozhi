# Acoustic Echo Cancellation (AEC) Configuration Guide

## Overview

Acoustic Echo Cancellation (AEC) is a key technology in voice interaction and is used to eliminate echo interference generated by speakers when playing. When the system plays audio, the microphone captures the playback content at the same time, resulting in reduced speech recognition accuracy.

**How ‚Äã‚ÄãAEC works:**

- Capture the audio signal input by the microphone (including user voice + echo)
- Get the reference signal played by the speaker
- Use an algorithm to subtract the predicted echo component from the microphone signal
- Output clean user voice signal

## Platform support architecture

py-xiaozhi adopts a cross-platform adaptive strategy and selects the optimal solution based on the characteristics of different operating systems:

```text
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   py-xiaozhi    ‚îÇ
                    ‚îÇ  AEC Processor  ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  Platform Check ‚îÇ
                    ‚îî‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îê ‚îå‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê ‚îå‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ  Windows  ‚îÇ ‚îÇLinux‚îÇ ‚îÇ   macOS   ‚îÇ
‚îÇ System-level AEC ‚îÇ ‚îÇPA-AEC‚îÇ ‚îÇWebRTC+BH ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ           ‚îÇ         ‚îÇ
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇReady to use out of the box‚îÇ ‚îÇConfiguration once‚îÇ ‚îÇConfiguration required‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### ü™ü Windows platform

- **Scheme**: System-level driver layer AEC
- **Advantages**: Zero configuration, ready to use out of the box
- **Principle**: Audio driver handles echo cancellation
- **Performance**: lowest latency, no overhead

### üêß Linux platform

- **Solution**: PulseAudio Modular AEC
- **Advantages**: System-level processing, application transparency
- **Principle**: module-echo-cancel + WebRTC algorithm
- **Configuration**: One-time configuration, lasting effect

### üçé macOS platform

- **Plan**: WebRTC + BlackHole virtual device
- **Advantages**: Real-time processing, controllable effects
- **Principle**: Application layer real-time algorithm processing
- **Configuration**: Virtual audio device needs to be installed

---

# üêß Linux platform configuration

## System requirements

| Projects | Requirements |
|------|------|
| **Operating System** | PulseAudio-based Linux distribution |
| **Test Environment** | Ubuntu 20.04+ / Fedora 35+ |
| **Hardware Recommendation** | External USB microphone + independent speaker |

> ‚ö†Ô∏è **Hardware Recommendation**: The laptop‚Äôs built-in microphone + speaker combination has limited AEC effects due to physical vibration coupling.

## Technical architecture

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Physical microphone ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ module-echo- ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Virtual device ‚îÇ
‚îÇ            ‚îÇ    ‚îÇ  cancel        ‚îÇ    ‚îÇ echoCancel_  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ source       ‚îÇ
                           ‚ñ≤               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ                      ‚îÇ
‚îÇ Speaker output ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚ñº
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                         ‚îÇ py-xiaozhi   ‚îÇ
‚îÇ Audio input ‚îÇ
                                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## One-click configuration script

### Download and install

```bash
# Download configuration script
git clone https://github.com/W-E-A/PulseAudio-AEC-Script.git
cd PulseAudio-AEC-Script

# Set execution permissions
chmod +x setup_aec.sh uninstall_aec.sh
```

### Run configuration

```bash
# Run the installation script (do not use sudo)
./setup_aec.sh
```

**Configuration process:**

1. **Device Detection** - Script scans all available microphone devices
2. **Device Selection** - Select the target microphone (USB external microphone recommended)
3. **Module Configuration** - Automatically configure the PulseAudio echo cancellation module
4. **Service Restart** - Restart the audio service to make the configuration take effect

### System settings

After configuration is complete:

1. Open the system "Sound" settings
2. **Input device**: Select a virtual microphone containing `echo cancellation`
3. **Output Device**: Select a virtual speaker with `echo cancellation`

### Effect verification

![AEC effect comparison](https://github.com/W-E-A/PulseAudio-AEC-Script/raw/main/assets/images/AEC_audio_effect.png)

### Uninstall configuration

```bash
#Restore original configuration
./uninstall_aec.sh
```

## troubleshooting

### FAQ

**Q1: ‚Äã‚ÄãThe echo cancellation device cannot be found after the script is run**

Solution:

```bash
# Check PulseAudio status
pactl list sources short
pactl list sinks short

# Restart the audio service
pulseaudio -k
```

**Q2: The built-in microphone AEC effect is not good**

Reason analysis:

- Physical vibration coupling: speaker vibration is transmitted to the built-in microphone
- Device compatibility: Some built-in devices do not support the AEC module

Suggested solution:

- Use external USB microphone + independent speaker
- Physical isolation of vibration sources

**Q3: Audio delay increased after configuration**

Tuning plan:

```bash
# Check buffer settings
pactl list sources | grep -A10 "echo-cancel"

#Adjust delay parameters (optional)
# Edit ~/.config/pulse/default.pa
# Add: load-module module-echo-cancel aec_args='"frame_size_ms=8"'
```

---

# üçé macOS platform configuration

## System requirements

| Projects | Requirements |
|------|------|
| **Operating system** | macOS 10.15+ |
| **Virtual Audio** | BlackHole 2ch |
| **Python dependencies** | webrtc-audio-processing |

## Technical architecture

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Physical microphone ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ WebRTC AEC ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ py-xiaozhi ‚îÇ
‚îÇ ‚îÇ ‚îÇ Real-time processing ‚îÇ ‚îÇ Audio input ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚ñ≤
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Aggregation Device/Multiple Outputs ‚îÇ
              ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îê                    ‚îå‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Physical Speakers ‚îÇ ‚îÇ BlackHole 2ch ‚îÇ
‚îÇ (User listening) ‚îÇ ‚îÇ (Reference signal) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Install BlackHole

### Method 1: Homebrew installation (recommended)

```bash
# Install BlackHole
brew install blackhole-2ch
```

### Method 2: Manual installation

1. Visit [BlackHole official page](https://github.com/ExistentialAudio/BlackHole)
2. Download the BlackHole 2ch installation package
3. Run the installer and authorize

## Audio device configuration

### Step 1: Create an aggregation device

> If it doesn‚Äôt work, create multiple devices, or check the speaker and blackhole. After consulting the information and AI, it is recommended to create an aggregation device, but in my actual test, only by creating multiple devices can I correctly use webrtc to eliminate echo.

1. Open "Applications" ‚Üí "Utilities" ‚Üí "Audio MIDI Settings"
2. Click the "+" sign in the lower left corner ‚Üí "Create Aggregation Device"
3. Configure the aggregation device:
- ‚úÖ MacBook Air Speakers (Main Device)
   - ‚úÖ BlackHole 2ch
- Sampling rate: 48.0 kHz

![Aggregation device configuration](./images/aggregation device.png)
![Multi-device configuration](./images/multi-device.png)

> üí° **Configuration Notes**: Aggregation device ensures synchronized audio output to speakers and BlackHole, providing precise time alignment for AEC

### Step 2: System Audio Settings

1. Open "System Preferences" ‚Üí "Sound"
2. **Output**: Select the newly created aggregation device
3. **Input**: Keep the default microphone device

![System Audio Settings](./images/System Speaker Selection.png)

> ‚ö†Ô∏è **Volume control limitation**: Aggregated devices cannot directly adjust the system volume. You can adjust the volume of each sub-device in the audio MIDI settings.

### Step 3: Verify device availability

```bash
# Check if the BlackHole device is recognized
python3 -c "
import sounddevice as sd
devices = sd.query_devices()
for i, device in enumerate(devices):
    if 'blackhole' in device['name'].lower():
print(f'[{i}] {device[\"name\"]} - {device[\"max_input_channels\"]}ch input')
"
```

## Apply automatic configuration

py-xiaozhi automatically executes when starting:

1. **Device Detection** - Scan and identify BlackHole 2ch devices
2. **AEC initialization** - Create WebRTC audio processing instance
3. **Reference Signal Stream** - Creating a BlackHole Audio Capture Stream
4. **Real-time processing** - Enables echo cancellation processing of microphone audio

### Configuration verification

```python
# Check AEC status
from src.audio_codecs.audio_codec import AudioCodec

codec = AudioCodec()
await codec.initialize()

# Get AEC status
status = codec.get_aec_status()
print(f"AEC enabled: {status['enabled']}")
print(f"Reference signal available: {status['reference_available']}")
```

## troubleshooting

### FAQ

#### Q1: BlackHole device not found

Solution:

```bash
# Reinstall BlackHole
brew reinstall blackhole-2ch

# Restart CoreAudio service
sudo launchctl kickstart -kp system/com.apple.audio.coreaudiod
```

#### Q2: Aggregation device cannot be created

Check items:

- Confirm that BlackHole is installed correctly
- Restart the "Audio MIDI Settings" application
- Check system audio permission settings

#### Q3: AEC is not effective

Optimization suggestions:

- Make sure to use an aggregate device rather than a multi-output device
- Adjust the physical distance between the microphone and the speaker
- Check ambient noise levels

#### Q4: Audio delay is too high

Tuning plan:

- Reduce audio buffer size
- Use wired audio devices instead of Bluetooth
- Close other audio processing software

---

# üß™ Configuration verification and testing

## Status check

### General status verification

```python
# Check the AEC status after starting py-xiaozhi
from src.audio_codecs.audio_codec import AudioCodec

codec = AudioCodec()
await codec.initialize()

# Get detailed status information
status = codec.get_aec_status()
print(f"AEC enabled status: {status['enabled']}")
print(f"Platform type: {status.get('aec_type', 'unknown')}")
print(f"Description: {status.get('description', 'N/A')}")
```

### Platform specific checks

#### Windows

```bash
# Check audio driver AEC support
# View the audio device properties in the device manager
```

#### Linux

```bash
# Verify PulseAudio AEC module
pactl list sources | grep -i "echo"
pactl list sinks | grep -i "echo"

# Check module loading status
pactl list modules | grep echo-cancel
```

#### macOS

```bash
# Verify BlackHole device
system_profiler SPAudioDataType | grep -i blackhole

# Check the aggregation device
# Confirm device status in audio MIDI settings
```

## Functional testing

- Theoretically, after turning on aec in config.json, it is normal to select automatic dialogue and not talk to yourself. Linux and mac need to be configured. For windows, I found a few people to test it, and it is normal. The bottom layer of the system has been processed.

## Reference resources

### Official Documentation

- [PulseAudio AEC Script](https://github.com/W-E-A/PulseAudio-AEC-Script) - Linux automatic configuration script
- [BlackHole official repository](https://github.com/ExistentialAudio/BlackHole) - macOS virtual audio device
- [WebRTC Audio Processing](https://webrtc.googlesource.com/src/+/refs/heads/master/modules/audio_processing/) - Algorithm implementation document
