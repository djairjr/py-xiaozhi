# Voice interaction mode description

![Image](./images/system interface.png)

## Project Overview

py-xiaozhi is an AI voice assistant client developed based on Python. It adopts a modern asynchronous architecture design and supports rich multi-modal interaction functions. The system integrates advanced technologies such as speech recognition, natural language processing, visual recognition, and IoT device control to provide users with an intelligent interactive experience.

### Core Features
- **Multi-protocol support**: WebSocket/MQTT dual-protocol communication
- **MCP Tool Ecosystem**: Integrated 10+ professional tool modules
- **IoT device integration**: Device management of Thing-based architecture
- **Visual Recognition**: Multi-modal understanding based on GLM-4V
- **Audio processing**: Opus encoding + WebRTC enhancement
- **Global shortcut keys**: System-level interactive control

## Voice interaction mode

The system provides a variety of voice interaction methods and supports flexible interactive control and intelligent voice detection:

### 1. Manual pressing mode

- **Operation method**: Press and hold the shortcut key to record, release it to automatically send
- **Default shortcut key**: `Ctrl+J` (can be modified in configuration)
- **Applicable Scenarios**: Accurately control recording time to avoid environmental noise interference
- **Advantage Features**:
- Avoid accidentally triggering recording
- The recording duration is completely controllable
- Suitable for use in noisy environments

### 2. Turn-based dialogue mode (AUTO_STOP)

- **Operation method**: Press the shortcut key to open/click the lower right corner of the GUI to switch to manual dialogue mode and automatic dialogue
- **Default shortcut key**: `Ctrl+K` (can be modified in configuration)
- **Applicable scenarios**: Quiet environment, traditional dialogue interaction, and when the AEC function is disabled
- **How ​​it works**:
- User speaks → AI replies → User speaks again
- Each conversation needs to wait for the AI ​​reply to be completed
- Avoid echoes and conflicts where both parties are talking at the same time
- The system automatically disables microphone input when the AI ​​speaks
- **Technical Features**:
- Default mode when AEC is disabled
- Ideal for one-way audio devices or environments with echo issues
- A more stable conversation experience to avoid audio conflicts

### 3. Real-time conversation mode (REALTIME)

- **How ​​to operate**: Automatically activate after enabling AEC echo cancellation
- **Configuration requirements**: `"AEC_OPTIONS.ENABLED": true`
- **Applicable scenarios**: natural dialogue, two-way interaction, complex environments, scenarios where AI needs to be interrupted
- **How ​​it works**:
- Supports users interrupting at the same time when AI is speaking
- Real-time two-way audio streaming processing
- Intelligent echo cancellation to prevent speaker sound from interfering with the microphone
- Microphone and speaker can work simultaneously
- **Technical Features**:
- Acoustic echo cancellation algorithm based on SpeexDSP
- Real-time noise suppression and audio pre-processing
- Low latency audio processing pipeline (typically <50ms)
- Reference signal buffering and adaptive filtering
-Supports full-duplex audio communication

### 4. Wake word mode

- **How ​​to operate**: Speak the preset wake word with your voice to activate the system
- **Default wake word**: "Xiao Zhi", "Xiao Mei" (can be customized in the configuration)
- **Model Support**: Based on Vosk offline speech recognition
- **Configuration requirements**: You need to download the corresponding speech recognition model

### AEC automatic mode selection

The system automatically selects the appropriate conversation mode based on the AEC configuration:

```json
// When AEC is enabled - automatically switches to live conversation mode
{
  "AEC_OPTIONS": {
    "ENABLED": true   // → ListeningMode.REALTIME
  }
}

// When AEC is disabled - use turn-based dialogue mode
{
  "AEC_OPTIONS": {
    "ENABLED": false  // → ListeningMode.AUTO_STOP
  }
}
```

**Mode selection logic**:
- Read AEC configuration status in `src/application.py:99`
- Determine the default `listening_mode` based on AEC status
- AEC enabled = supports real-time two-way conversations
- AEC disabled = use traditional turn-based dialogue

### Mode switching and configuration

```json
// Configure shortcut keys in config/config.json
{
  "SHORTCUTS": {
    "ENABLED": true,
    "MANUAL_PRESS": {"modifier": "ctrl", "key": "j"},
    "AUTO_TOGGLE": {"modifier": "ctrl", "key": "k"},
    "MODE_TOGGLE": {"modifier": "ctrl", "key": "m"}
  }
}
```

- **Interface display**: The current interaction mode is displayed in real time in the lower right corner of the GUI
- **Quick Switch**: Use `Ctrl+M` to quickly switch between different modes
- **Status Indication**: The color of the system tray icon reflects the current status
- **Automatic Adaptation**: The system automatically selects the best conversation mode based on the AEC configuration.

## Dialog control and system status

### Intelligent interruption function

While the AI ​​is speaking back, the user can interrupt the conversation at any time:

- **Shortcut key to interrupt**: `Ctrl+Q` - Immediately stop the current AI reply
- **GUI operation**: Click the "Interrupt" button on the interface
- **Smart Detection**: The system automatically interrupts the reply when it detects new voice input

### System status management

The system adopts an event-driven state machine architecture and has the following operating states:

```
┌─────────────────────────────────────────────────────────┐
│ System status flow diagram │
└─────────────────────────────────────────────────────────┘

     IDLE              CONNECTING           LISTENING
┌─────────┐ Wake word/button ┌─────────┐ Connection successful ┌──────────┐
│ Idle │ ─────────────> │ Connecting │ ─────────> │ Listening │
│ Standby │ │ Server │ │ Recording │
  └─────────┘                └─────────┘           └─────────┘
       ↑                           │                     │
│ Connection failed │ Voice recognition
│ │ │ Completion/Timeout
       │                           ↓                     │
       │                     ┌─────────┐                 │
└──── Play completed/interrupted ──── │ Replying │ <───────────────┘
│ AI speaks │
                             └─────────┘
```

### Status indication description

**System tray icon color**:
- **Green**: The system is running normally and is on standby.
- **Yellow**: Listening to user voice input
- **Blue**: AI is responding with voice
- **Red**: System error or connection abnormality
- **Gray**: Not connected to the server

## Shortcut key system

The system provides rich global shortcut key support. For detailed description, please refer to: [Shortcut Key Description](./Shortcut Key Description.md)

### Commonly used shortcut keys

| Shortcut keys | Function description | Remarks |
|--------|----------|------|
| `Ctrl+J` | Press and hold to speak mode | Press and hold to record, release to send |
| `Ctrl+K` | Automatic conversation mode | Turn on/off automatic voice detection |
| `Ctrl+Q` | Interrupt conversation | Stop AI reply immediately |
| `Ctrl+M` | Switch interactive mode | Switch between manual/automatic mode |
| `Ctrl+W` | Show/hide window | Minimize/restore window |

## Intelligent voice command system

### Basic interactive commands
- **Greetings**: "Hello", "Who are you", "Good morning"
- **Polite words**: "Thank you", "Goodbye", "Please help me"
- **Status query**: "What is the system status?" "Is the connection normal?"

### Visual recognition commands

Integrated GLM-4V multi-modal understanding capabilities:

```bash
#Visual identity analysis
"Identify screen" # Analyze the current camera screen
"Look at what's in front of the camera" # describe what you see
"What is this" # Object recognition
```

### MCP tool calling command

Take advantage of the rich MCP tool ecosystem:

```bash
# Calendar management
"Create a meeting reminder for tomorrow at 3pm"
"View today's schedule"

# Timer function
"Play Chrysanthemum Channel in one minute"

# System operations
"View system information"
"Adjust the volume to 80%"

# web search
"Search for today's weather"
"Find recent hotspots"

# Map navigation
"Find a nearby coffee shop"
"Navigate to Beijing Tiananmen"

# Gourmet Recipes
"Recommended recipes for today's dinner"
"Teach me how to make Kung Pao Chicken"

# Bazi numerology (optional)
"Analyze my birthday and horoscope"
"How's your luck today?"
```

## Running mode and deployment

### GUI mode (default)

Graphical user interface mode provides an intuitive interactive experience:

```bash
# Standard startup
python main.py

# Use MQTT protocol
python main.py --protocol mqtt
```

**GUI mode features**:
- Visual operation interface
- Real-time status display
- Audio waveform visualization
- System tray support
- Graphical setting interface

### CLI mode

Command line interface mode, suitable for server deployment:

```bash
# Start in CLI mode
python main.py --mode cli

# CLI + MQTT protocol
python main.py --mode cli --protocol mqtt
```

**CLI Mode Features**:
- Low resource usage
- Server friendly
- Detailed log output
- Keyboard shortcut support
- Scripted deployment

**Build Features**:
- Cross-platform support
- Single file mode
- Dependency packaging
- Automated configuration

## Platform compatibility

### Windows Platform
- **Fully Compatible**: All functions are supported normally
- **Audio Enhancement**: Support Windows Audio API
- **Volume Control**: Integrated pycaw volume management
- **System Tray**: Full tray function support
- **Global Hotkeys**: Complete shortcut key functions

### macOS platform
- **Fully Compatible**: Core functions fully supported
- **Status Bar**: The tray icon is displayed in the top status bar
- **Permission Management**: May need to authorize microphone/camera permissions
- **Shortcut keys**: Some shortcut keys require system permissions
- **Audio**: Native CoreAudio support

### Linux Platform
- **Compatibility**: Supports mainstream distributions (Ubuntu/CentOS/Debian)
- **Desktop Environment**:
- GNOME: full support
- KDE: full support
- Xfce: requires additional tray support
- **Audio System**:
- PulseAudio: Recommended (automatically detected)
- ALSA: Alternate plan
- **Dependencies**: You may need to install the system tray support package

```bash
# Ubuntu/Debian tray support
sudo apt-get install libappindicator3-1

# CentOS/RHEL tray support
sudo yum install libappindicator-gtk3
```

## Troubleshooting Guide

### FAQ

**1. Voice recognition not working**
- Use easy-to-recognize wake words such as Xiaomei and Xiaoming

**2. The camera cannot be used**
```bash
# test camera
python scripts/camera_scanner.py

# Check camera permissions and device index
```

**3. Shortcut keys do not respond**
- Check if there are other programs occupying the same shortcut keys
- Try running with administrator rights (Windows)
- Check system security software interception

**4. Network connection issues**
- Check firewall settings
- Verify WebSocket/MQTT server address
- Test network connectivity