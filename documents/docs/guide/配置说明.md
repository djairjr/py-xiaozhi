# Configuration instructions

## Configuration system overview

### Configuration file structure
py-xiaozhi adopts a hierarchical configuration system and supports multiple configuration management methods:

```
config/
├── config.json # Main configuration file (runtime configuration)
└── efuse.json # Device identity file (automatically generated)
```

### Configuration hierarchy

1. **Default configuration template**
- Location: `DEFAULT_CONFIG` in `src/utils/config_manager.py`
- Function: Provide system default configuration values
- Purpose: Automatically generate a template for the configuration file when running for the first time

2. **Runtime configuration file**
- Location: `config/config.json`
- Function: Store user-defined configuration
- Purpose: The actual configuration read when the system is running

3. **Device Identity File**
- Location: `config/efuse.json`
- Function: Store the unique identification and activation status of the device
- Purpose: Device activation and authentication

### Configure access method

The configuration system supports dot-delimited path access to facilitate obtaining and modifying nested configurations:

```python
# Get configuration example
from src.utils.config_manager import ConfigManager
config = ConfigManager.get_instance()

# Get network configuration
websocket_url = config.get_config("SYSTEM_OPTIONS.NETWORK.WEBSOCKET_URL")

# Get wake word configuration
wake_words = config.get_config("WAKE_WORD_OPTIONS.WAKE_WORDS")

# Update configuration
config.update_config("WAKE_WORD_OPTIONS.USE_WAKE_WORD", True)
config.update_config("CAMERA.VLapi_key", "your_api_key_here")

# Reload configuration
config.reload_config()
```

## System Configuration (SYSTEM_OPTIONS)

### Basic system configuration

```json
{
  "SYSTEM_OPTIONS": {
"CLIENT_ID": "Automatically generated client ID",
"DEVICE_ID": "Device MAC address",
    "NETWORK": {
      "OTA_VERSION_URL": "https://api.tenclass.net/xiaozhi/ota/",
      "WEBSOCKET_URL": "wss://api.tenclass.net/xiaozhi/v1/",
"WEBSOCKET_ACCESS_TOKEN": "Access Token",
      "MQTT_INFO": {
        "endpoint": "mqtt.server.com",
        "client_id": "xiaozhi_client",
        "username": "your_username",
        "password": "your_password",
        "publish_topic": "xiaozhi/commands",
        "subscribe_topic": "xiaozhi/responses"
      },
      "ACTIVATION_VERSION": "v2",
      "AUTHORIZATION_URL": "https://xiaozhi.me/"
    }
  }
}
```

### Configuration item description

| Configuration item | Type | Default value | Description |
|--------|------|--------|------|
| `CLIENT_ID` | String | Automatically generated | Client unique identifier |
| `DEVICE_ID` | String | MAC address | Device unique identifier |
| `OTA_VERSION_URL` | String | Official OTA address | OTA configuration acquisition address |
| `WEBSOCKET_URL` | String | Issued by OTA | WebSocket server address |
| `WEBSOCKET_ACCESS_TOKEN` | String | Issued by OTA | WebSocket access token |
| `ACTIVATION_VERSION` | String | "v2" | Activation protocol version (v1/v2) |
| `AUTHORIZATION_URL` | String | "https://xiaozhi.me/" | Device authorization address |

## Server configuration replacement

### Replace the self-deployed server

If you need to use a self-deployed server, you only need to modify the OTA interface address, and the system will automatically obtain the WebSocket connection information from the OTA server:

```json
{
  "SYSTEM_OPTIONS": {
    "NETWORK": {
      "OTA_VERSION_URL": "https://your-server.com/xiaozhi/ota/"
    }
  }
}
```

### Configure automatic update mechanism

When the system starts, the configuration will be automatically updated through the following process:

1. **OTA configuration acquisition**: Send a POST request to `OTA_VERSION_URL`
2. **Configuration automatic update**: The system automatically updates MQTT and WebSocket configurations
3. **Connection Establishment**: Use the updated configuration to establish a connection.

Relevant code location:
- OTA configuration acquisition: `fetch_and_update_config()` method of `src/core/ota.py`
- Configuration update: `update_websocket_config()` and `update_mqtt_config()` methods of `src/core/ota.py`

### Disable automatic configuration updates

If you do not need to configure automatic updates, you can comment the relevant code in the following location:

**1. Disable OTA configuration acquisition**

Comment out the third stage in `src/core/system_initializer.py`:

```python
# async def stage_3_ota_config(self):
#     """
# The third stage: OTA obtains configuration.
#     """
# # Comment out the entire method content
```

**2. Disable WebSocket configuration updates**

Comment the update method in `src/core/ota.py`:

```python
async def update_websocket_config(self, response_data):
    """
Update WebSocket configuration information.
    """
# Comment out the configuration update logic
    return None
```

**3. Manually configure WebSocket connection**

Configure fixed connection information directly in `config/config.json`:

```json
{
  "SYSTEM_OPTIONS": {
    "NETWORK": {
      "WEBSOCKET_URL": "wss://your-server.com/xiaozhi/v1/",
      "WEBSOCKET_ACCESS_TOKEN": "your_fixed_token"
    }
  }
}
```

## Wake word configuration (WAKE_WORD_OPTIONS)

### Sherpa-ONNX Voice Wakeup Settings

```json
{
  "WAKE_WORD_OPTIONS": {
    "USE_WAKE_WORD": true,
    "MODEL_PATH": "models",
    "NUM_THREADS": 4,
    "PROVIDER": "cpu",
    "MAX_ACTIVE_PATHS": 2,
    "KEYWORDS_SCORE": 1.8,
    "KEYWORDS_THRESHOLD": 0.2,
    "NUM_TRAILING_BLANKS": 1
  }
}
```

### Configuration item description

| Configuration item | Type | Default value | Description |
|--------|------|--------|------|
| `USE_WAKE_WORD` | Boolean | true | Whether to enable voice wake-up |
| `MODEL_PATH` | String | "models" | Sherpa-ONNX model file directory |
| `NUM_THREADS` | Integer | 4 | The number of model inference threads, which affects the response speed |
| `PROVIDER` | String | "cpu" | Inference engine (cpu/cuda/coreml) |
| `MAX_ACTIVE_PATHS` | Integer | 2 | Number of search paths, affecting accuracy and speed |
| `KEYWORDS_SCORE` | Float | 1.8 | Keyword enhancement score, affecting detection sensitivity |
| `KEYWORDS_THRESHOLD` | Float | 0.2 | Detection threshold, the lower the value, the more sensitive it is |
| `NUM_TRAILING_BLANKS` | Integer | 1 | Number of trailing blank tokens |

### Model file structure

```bash
models/
├── encoder.onnx # Encoder model (high-precision version built-in)
├── decoder.onnx # Decoder model
├── joiner.onnx # Connector model
├── tokens.txt # Pinyin token mapping table
└── keywords.txt # Keyword configuration file
```

### Custom wake word

Edit `models/keywords.txt` to add wake words:

```
# Format: Pinyin decomposition @Chinese original text
n ǐ h ǎo x iǎo zh ì @你好小智
j iā w éi s ī @jarvis
x iǎo zh ù sh ǒu @小 Assistant
k āi sh ǐ g ōng z uò @start working
```

### Performance Tuning

#### Speed ​​priority configuration:
```json
{
  "WAKE_WORD_OPTIONS": {
    "NUM_THREADS": 6,
    "MAX_ACTIVE_PATHS": 1,
    "KEYWORDS_THRESHOLD": 0.15,
    "KEYWORDS_SCORE": 1.5
  }
}
```

#### Accuracy priority configuration:
```json
{
  "WAKE_WORD_OPTIONS": {
    "NUM_THREADS": 4,
    "MAX_ACTIVE_PATHS": 3,
    "KEYWORDS_THRESHOLD": 0.25,
    "KEYWORDS_SCORE": 2.2
  }
}
```

## Camera configuration (CAMERA)

### Visual recognition settings

```json
{
  "CAMERA": {
    "camera_index": 0,
    "frame_width": 640,
    "frame_height": 480,
    "fps": 30,
    "Local_VL_url": "https://open.bigmodel.cn/api/paas/v4/",
    "VLapi_key": "your_zhipu_api_key",
    "models": "glm-4v-plus"
  }
}
```

### Configuration item description

| Configuration item | Type | Default value | Description |
|--------|------|--------|------|
| `camera_index` | Integer | 0 | Camera device index |
| `frame_width` | Integer | 640 | Frame width |
| `frame_height` | Integer | 480 | Frame height |
| `fps` | Integer | 30 | Frame rate |
| `Local_VL_url` | String | Wisdom spectrum API address | Visual model API address |
| `VLapi_key` | String | "" | Zhipu API key |
| `models` | String | "glm-4v-plus" | Visual model name |

### Camera test

```bash
# Test camera function
python scripts/camera_scanner.py

# Test visual recognition in the program
Voice inquiry, see what is in front of the camera?
```

## Shortcut key configuration (SHORTCUTS)

### Global shortcut key settings

```json
{
  "SHORTCUTS": {
    "ENABLED": true,
    "MANUAL_PRESS": {
      "modifier": "ctrl",
      "key": "j",
"description": "Hold to speak"
    },
    "AUTO_TOGGLE": {
      "modifier": "ctrl",
      "key": "k",
"description": "Automatic conversation"
    },
    "ABORT": {
      "modifier": "ctrl",
      "key": "q",
"description": "Interrupt conversation"
    },
    "MODE_TOGGLE": {
      "modifier": "ctrl",
      "key": "m",
"description": "Switch mode"
    },
    "WINDOW_TOGGLE": {
      "modifier": "ctrl",
      "key": "w",
"description": "Show/hide window"
    }
  }
}
```

### Shortcut key description

| Shortcut keys | Function | Description |
|--------|------|------|
| `Ctrl+J` | Press and hold to speak | Record while pressing and send after releasing |
| `Ctrl+K` | Automatic dialogue | Turn on/off automatic dialogue mode |
| `Ctrl+Q` | Interrupt conversation | Interrupt current conversation |
| `Ctrl+M` | Switch modes | Switch between different conversation modes |
| `Ctrl+W` | Show/hide windows | Show or hide the main window |

## Acoustic echo cancellation configuration (AEC_OPTIONS)

### AEC Audio Processing Settings

```json
{
  "AEC_OPTIONS": {
    "ENABLED": true,
    "BUFFER_MAX_LENGTH": 200,
    "FRAME_DELAY": 3,
    "FILTER_LENGTH_RATIO": 0.4,
    "ENABLE_PREPROCESS": true
  }
}
```

### Configuration item description

| Configuration item | Type | Default value | Description |
|--------|------|--------|------|
| `ENABLED` | Boolean | true | Whether to enable the AEC echo cancellation function |
| `BUFFER_MAX_LENGTH` | Integer | 200 | Reference signal buffer size (number of frames) |
| `FRAME_DELAY` | Integer | 3 | Number of delay compensation frames (not used yet) |
| `FILTER_LENGTH_RATIO` | Float | 0.4 | Filter length ratio (seconds), affecting echo cancellation strength |
| `ENABLE_PREPROCESS` | Boolean | true | Whether to enable noise suppression preprocessing |

### AEC function description

**Echo Cancellation**
- Eliminate the echo in the microphone caused by speaker playback audio
- Support real-time two-way dialogue to avoid echo interference

**Noise Suppression**
- Suppress background noise and environmental interference
- Improve speech recognition accuracy

**Conversation Mode Impact**
```json
{
  "AEC_OPTIONS": {
"ENABLED": true // When enabled: real-time conversation mode (ListeningMode.REALTIME)
// When disabled: turn-based dialogue mode (ListeningMode.AUTO_STOP)
  }
}
```

### Environmental optimization suggestions

**Small room/office environment**
```json
{
  "AEC_OPTIONS": {
    "FILTER_LENGTH_RATIO": 0.2,
    "BUFFER_MAX_LENGTH": 150
  }
}
```

**Large Room/Meeting Room Environment**
```json
{
  "AEC_OPTIONS": {
    "FILTER_LENGTH_RATIO": 0.6,
    "BUFFER_MAX_LENGTH": 300
  }
}
```

**Noisy environment**
```json
{
  "AEC_OPTIONS": {
    "FILTER_LENGTH_RATIO": 0.8,
    "ENABLE_PREPROCESS": true,
    "BUFFER_MAX_LENGTH": 400
  }
}
```

### AEC functional test

```bash
# Test echo cancellation effect
# 1. Enable AEC, play music and talk at the same time
python main.py # There should be no echo when AEC is enabled

# 2. Disable AEC contrast effect
# Modify configuration file "ENABLED": false
python main.py # There may be echo when AEC is disabled
```

### Performance parameter description

**Filter length calculation**
```
Actual filter length = sampling rate (16000Hz) × FILTER_LENGTH_RATIO
For example: FILTER_LENGTH_RATIO = 0.4 → filter length = 6400 samples (0.4 seconds)
```

**Parameter impact**
- **Filter length↑**: echo cancellation effect↑, CPU consumption↑
- **Buffer Length↑**: Stability↑, Memory Consumption↑
- **Preprocessing enabled**: noise suppression ↑, slight delay ↑

## Detailed explanation of protocol configuration

### WebSocket protocol configuration

WebSocket connection information is usually automatically issued by the OTA server and does not require manual configuration:

```json
{
  "SYSTEM_OPTIONS": {
    "NETWORK": {
      "WEBSOCKET_URL": "wss://your-server.com/xiaozhi/v1/",
      "WEBSOCKET_ACCESS_TOKEN": "your_access_token"
    }
  }
}
```

**Configuration points:**
- URL must start with `ws://` or `wss://`
- Support IP address or domain name
- The default port is 8000, which can be adjusted according to the server configuration
- Access token used for authentication
- Usually automatically configured by OTA server, no manual setup required

### MQTT protocol configuration

```json
{
  "SYSTEM_OPTIONS": {
    "NETWORK": {
      "MQTT_INFO": {
        "endpoint": "mqtt.server.com",
        "port": 1883,
        "client_id": "xiaozhi_client_001",
        "username": "your_username",
        "password": "your_password",
        "publish_topic": "xiaozhi/commands",
        "subscribe_topic": "xiaozhi/responses",
        "qos": 1,
        "keep_alive": 60
      }
    }
  }
}
```

**Configuration points:**
- `endpoint`: MQTT server address
- `port`: usually 1883 (unencrypted) or 8883 (TLS encrypted)
- `client_id`: unique identifier of the client
- `qos`: message quality level (0-2)
- `keep_alive`: heartbeat interval (seconds)

## Device activation configuration

### Activation version description

```json
{
  "SYSTEM_OPTIONS": {
    "NETWORK": {
      "ACTIVATION_VERSION": "v2",
      "AUTHORIZATION_URL": "https://xiaozhi.me/"
    }
  }
}
```

**Version Difference:**
- **v1**: Simplified activation process, no verification code required
- **v2**: Complete activation process, including verification code verification

### Device identity file (efuse.json)

```json
{
  "serial_number": "SN-E3E1F618-902e16dbe116",
  "hmac_key": "b5bf012dd518080532f928b70ed958799f34f9224e80dd4128795a70a5baca24",
  "activation_status": false,
  "mac_address": "00:11:22:33:44:55",
  "device_fingerprint": {
    "cpu_info": "...",
    "memory_info": "...",
    "disk_info": "..."
  }
}
```

**Field description:**
- `serial_number`: device serial number
- `hmac_key`: device authentication key
- `activation_status`: activation status
- `mac_address`: device MAC address
- `device_fingerprint`: device fingerprint information

## Practical tips for configuration management

### 1. Configuration file generation

```bash
# Automatically generate configuration for first run
python main.py

# Regenerate default configuration
rm config/config.json
python main.py
```

### 2. Configuration backup and recovery

```bash
# Backup configuration
cp config/config.json config/config.json.bak

# Restore configuration
cp config/config.json.bak config/config.json
```

## Common configuration issues

### 1. WebSocket connection failed

**Symptom**: Unable to connect to server

**Solution**:
1. Check whether OTA_VERSION_URL is correct
2. Make sure the OTA server can respond normally
3. Check network connection

### 2. Wake word not working

**Symptoms**: No response to voice wake-up

**Solution**:
```json
{
  "WAKE_WORD_OPTIONS": {
    "USE_WAKE_WORD": true,
    "MODEL_PATH": "models/vosk-model-small-cn-0.22",
"WAKE_WORDS": ["Xiaozhi", "Xiaomei"]
  }
}
```

**Check Steps**:
1. Make sure the model file exists
2. Check audio device permissions
3. Test microphone function

### 3. The camera cannot be used

**Symptoms**: Abnormal camera function

**Solution**:
```json
{
  "CAMERA": {
    "camera_index": 0,
"VLapi_key": "Valid VLapi API key"
  }
}
```

**Check Steps**:
1. Run the camera test script
2. Check API key validity
3. Verify network connection

### 4. Device activation failed

**Symptom**: An error occurred during activation

**Solution**:
1. Check network connection
2. Confirm activation version settings
3. Clean device identity files:
   ```bash
   rm config/efuse.json
python main.py # Reactivate
   ```

### 5. Poor echo cancellation effect

**Symptoms**: Hearing an echo or your own voice during a conversation

**Solution**:
```json
{
  "AEC_OPTIONS": {
    "ENABLED": true,
"FILTER_LENGTH_RATIO": 0.6, // Increase filter length
"ENABLE_PREPROCESS": true, // Make sure preprocessing is enabled
"BUFFER_MAX_LENGTH": 300 // Increase buffer size
  }
}
```

**Check Steps**:
1. Make sure the AEC function is enabled
2. Adjust the filter length according to the room size
3. Check whether the audio device supports full duplex
4. Test different FILTER_LENGTH_RATIO values ​​(0.2-0.8)

### 6. Real-time conversation interruption

**Symptoms**: Frequent interruptions in live conversation mode

**Solution**:
```json
{
  "AEC_OPTIONS": {
"ENABLED": true, // Make sure AEC is enabled
"BUFFER_MAX_LENGTH": 400, // Increase buffer
"FILTER_LENGTH_RATIO": 0.4 // Moderate filter length
  }
}
```

**Check Steps**:
1. Check network connection stability
2. Monitor CPU usage
3. Confirm that the audio device driver is normal
4. View AEC statistics in the logs

## Configuration file template

### Complete configuration example

```json
{
  "SYSTEM_OPTIONS": {
    "CLIENT_ID": "12345678-1234-1234-1234-123456789012",
    "DEVICE_ID": "00:11:22:33:44:55",
    "NETWORK": {
      "OTA_VERSION_URL": "https://api.tenclass.net/xiaozhi/ota/",
      "WEBSOCKET_URL": "wss://api.tenclass.net/xiaozhi/v1/",
      "WEBSOCKET_ACCESS_TOKEN": "your_access_token",
      "MQTT_INFO": {
        "endpoint": "mqtt.server.com",
        "client_id": "xiaozhi_client",
        "username": "your_username",
        "password": "your_password",
        "publish_topic": "xiaozhi/commands",
        "subscribe_topic": "xiaozhi/responses"
      },
      "ACTIVATION_VERSION": "v2",
      "AUTHORIZATION_URL": "https://xiaozhi.me/"
    }
  },
  "WAKE_WORD_OPTIONS": {
    "USE_WAKE_WORD": true,
    "MODEL_PATH": "models/vosk-model-small-cn-0.22",
"WAKE_WORDS": ["Xiaozhi", "Xiaomei", "Hello Xiaozhi"]
  },
  "CAMERA": {
    "camera_index": 0,
    "frame_width": 640,
    "frame_height": 480,
    "fps": 30,
    "Local_VL_url": "https://open.bigmodel.cn/api/paas/v4/",
    "VLapi_key": "your_zhipu_api_key",
    "models": "glm-4v-plus"
  },
  "SHORTCUTS": {
    "ENABLED": true,
    "MANUAL_PRESS": {
      "modifier": "ctrl",
      "key": "j",
"description": "Hold to speak"
    },
    "AUTO_TOGGLE": {
      "modifier": "ctrl",
      "key": "k",
"description": "Automatic conversation"
    },
    "ABORT": {
      "modifier": "ctrl",
      "key": "q",
"description": "Interrupt conversation"
    },
    "MODE_TOGGLE": {
      "modifier": "ctrl",
      "key": "m",
"description": "Switch mode"
    },
    "WINDOW_TOGGLE": {
      "modifier": "ctrl",
      "key": "w",
"description": "Show/hide window"
    }
  },
  "AEC_OPTIONS": {
    "ENABLED": true,
    "BUFFER_MAX_LENGTH": 200,
    "FRAME_DELAY": 3,
    "FILTER_LENGTH_RATIO": 0.4,
    "ENABLE_PREPROCESS": true
  }
}
```

